#!/usr/bin/env python

import os
from optparse import OptionParser

from skadi.core.demo import Demo
from skadi.cli.delegate.creates_dts import CreatesDTs
from skadi.cli.delegate.processes_packets import ProcessesPackets
from skadi.cli.model import tree, encoder

usage  = "usage: %prog [options] 12345678.dem ..."
parser = OptionParser(usage)
parser.add_option('-S', '--search',
    action="append",
    help="paths to be searched (in order) for demo files",
)

(options, args) = parser.parse_args()

# This is ghetto and only accepts arguments relative to
# project root, ex. demos/12345678.dem
pwd  = os.path.dirname(__file__)
root = os.path.join(pwd, '..')

for arg in args:
    path   = os.path.join(root, arg)
    replay = Demo(path)

    creates_dts       = CreatesDTs()
    processes_packets = ProcessesPackets()

    replay.register(creates_dts, Demo.SendTables)
    replay.register(processes_packets, Demo.Packet)
    replay.parse()

    tree                   = tree.build_with(creates_dts.dts)
    nodes_with_encoded_dts = tree.select(lambda node, depth: True) #node.dt.encoded)

    count = 0
    for node in nodes_with_encoded_dts:
        print "DT: %s" % node.dt.name
        e = encoder.amass_sendprops(tree, node.dt)
        for index, s in enumerate(e):
            count += 1
            print "  %i: %s (%s) t=%i; p=%i; f=%s" % (index, s.name, s.origin.name, s.type, s.priority, bin(s.flags)[2:].zfill(20))

    print
    print count